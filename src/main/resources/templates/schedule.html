<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ì¼ì • ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ko.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="/css/schedule.css">
</head>
<body>
    <div class="container">
        <!-- ì‚¬ì´ë“œë°” -->
        <div th:replace="~{layout/sidebar :: sidebar}"></div>

        <!-- ì¼ì • ê´€ë¦¬ ì»¨í…ì¸  -->
        <div class="content">
            <h2>ì¼ì • ê´€ë¦¬</h2>
            <p>ìº˜ë¦°ë”ë¥¼ í†µí•´ ì¼ì •ì„ ì¶”ê°€, ì¡°íšŒ, ìˆ˜ì •, ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

            <!-- FullCalendar -->
            <div id="calendar"></div>
        </div>
    </div>

    <script>
    $(document).ready(function () {
        let calendarTag = $('#calendar')[0]; // full-calendar ìƒì„±í•˜ê¸°
        let calendar = new FullCalendar.Calendar(calendarTag, {
            height: '550px', // calendar ë†’ì´ ì„¤ì •
            expandRows: true, // í™”ë©´ì— ë§ê²Œ ë†’ì´ ì¬ì„¤ì •
            slotMinTime: '00:00', // Day ìº˜ë¦°ë”ì—ì„œ ì‹œì‘ ì‹œê°„
            slotMaxTime: '23:59', // Day ìº˜ë¦°ë”ì—ì„œ ì¢…ë£Œ ì‹œê°„

            customButtons: { // ì‚¬ìš©ìê°€ ë§Œë“œëŠ” ë²„íŠ¼
                testButton: {
                    text: "í…ŒìŠ¤íŠ¸ë²„íŠ¼"
                }
            },
            // í•´ë”ì— í‘œì‹œí•  íˆ´ë°”
            headerToolbar: { // customButton ì€ left ë˜ëŠ” right ì•ˆì— ë„£ìœ¼ë©´ ì ìš© ëœë‹¤
                left: 'prevYear,prev,next,nextYear today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            initialView: 'dayGridMonth', // ê¸°ë³¸ í™”ë©´ (ì›”ë³„ ë³´ê¸°)
            navLinks: true, // ë‚ ì§œë¥¼ ì„ íƒí•˜ë©´ Day ìº˜ë¦°ë”ë‚˜ Week ìº˜ë¦°ë”ë¡œ ë§í¬
            editable: true, // ì¼ì • ë“œë˜ê·¸ ì´ë™ ê°€ëŠ¥
            selectable: true, // ë‚ ì§œ ë“œë˜ê·¸ ê°€ëŠ¥
            nowIndicator: true, // í˜„ì¬ ì‹œê°„ í‘œì‹œ
            dayMaxEvents: true, // ì¼ì • ë§ìœ¼ë©´ +ë¡œ í‘œì‹œ
            locale: 'ko', // í•œêµ­ì–´ ì„¤ì •

            // âœ… ì¼ì • ì¡°íšŒ (ì„œë²„ì—ì„œ ì¼ì • ê°€ì ¸ì˜¤ê¸°)
            events: function(fetchInfo, successCallback, failureCallback) {
                $.ajax({
                    url: "/api/schedules",
                    type: "GET",
                    dataType: "json",
                    success: function(response) {
                        console.log("ğŸ“Œ ì¼ì • ë°ì´í„°:", response);
                        successCallback(response); // ì¼ì • ë¡œë“œ
                    },
                    error: function(xhr, status, error) {
                        console.error("ğŸš¨ ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
                        failureCallback(error);
                    }
                });
            },

            // âœ… ì¼ì • ì¶”ê°€ (ì¼ì í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸í•˜ì—¬ ì„ íƒ)
            select: function(arg) {
                let title = prompt("ìƒˆë¡œìš´ ì¼ì • ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:");
                if (title) {
                    let newEvent = {
                        title: title,
                        startDate: arg.startStr,
                        endDate: arg.endStr
                    };

                    $.ajax({
                        url: "/api/schedules",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(newEvent),
                        success: function(data) {
                            console.log("âœ… ì¼ì • ì¶”ê°€ ì™„ë£Œ:", data);
                            calendar.addEvent({
                                id: data.scheduleId, // ì„œë²„ì—ì„œ ë°˜í™˜ëœ ì¼ì • ID ì‚¬ìš©
                                title: data.title,
                                start: data.startDate,
                                end: data.endDate,
                                allDay: true
                            });
                            alert("ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        },
                        error: function() {
                            alert("ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        }
                    });
                }
                calendar.unselect();
            },

            // âœ… ì¼ì • ìˆ˜ì • (ë“œë˜ê·¸ & ë“œë¡­)
            eventDrop: function(info) {
                let updatedEvent = {
                    scheduleId: info.event.id,
                    title: info.event.title,
                    startDate: info.event.start.toISOString(),
                    endDate: info.event.end ? info.event.end.toISOString() : info.event.start.toISOString()
                };

                $.ajax({
                    url: "/api/schedules/" + updatedEvent.scheduleId,
                    type: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(updatedEvent),
                    success: function() {
                        alert("ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    },
                    error: function() {
                        alert("ì¼ì • ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            },

            // âœ… ì¼ì • ì‚­ì œ (ì¼ì • í´ë¦­ ì‹œ)
            eventClick: function(info) {
                if (confirm("ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    $.ajax({
                        url: "/api/schedules/" + info.event.id,
                        type: "DELETE",
                        success: function() {
                            alert("ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            info.event.remove();
                        },
                        error: function() {
                            alert("ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        }
                    });
                }
            }
        });

        // ìº˜ë¦°ë” ëœë”ë§
        calendar.render();
    });
    </script>
</body>
</html>
