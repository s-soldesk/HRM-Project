<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>ì¼ì • ê´€ë¦¬</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ko.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="/css/schedule.css">
</head>
<body>
    <div class="container">
        <!-- ì‚¬ì´ë“œë°” -->
        <div th:replace="~{layout/sidebar :: sidebar}"></div>

        <!-- ì¼ì • ê´€ë¦¬ ì»¨í…ì¸  -->
        <div class="content">
            <h2>ì¼ì • ê´€ë¦¬</h2>
            <p>ìº˜ë¦°ë”ë¥¼ í†µí•´ ì¼ì •ì„ ì¶”ê°€, ì¡°íšŒ, ìˆ˜ì •, ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

            <!-- FullCalendar -->
            <div id="calendar"></div>
        </div>
    </div>

    <script>
    $(document).ready(function () {
        let calendarTag = $('#calendar')[0];
        let calendar = new FullCalendar.Calendar(calendarTag, {
            height: '550px',
            expandRows: true,
            slotMinTime: '00:00',
            slotMaxTime: '23:59',
            headerToolbar: {
                left: 'prevYear,prev,next,nextYear today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            initialView: 'dayGridMonth',
            navLinks: true,
            editable: true,
            selectable: true,
            nowIndicator: true,
            dayMaxEvents: true,
            locale: 'ko',

            // âœ… ëª¨ë“  ì§ì›ì˜ ì¼ì • ì¡°íšŒ
            events: function(fetchInfo, successCallback, failureCallback) {
                $.ajax({
                    url: "/api/schedules",
                    type: "GET",
                    dataType: "json",
                    success: function(response) {
                        let events = response.map(schedule => ({
                            id: schedule.scheduleId,
                            title: schedule.title + " (ì§ì›: " + schedule.employeeId + ")",
                            start: schedule.startDate,
                            end: schedule.endDate,
                            allDay: true
                        }));
                        successCallback(events);
                    },
                    error: function(xhr, status, error) {
                        console.error("ğŸš¨ ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:", error);
                        failureCallback(error);
                    }
                });
            },

            // âœ… ì¼ì • ì¶”ê°€
            select: function(arg) {
                let title = prompt("ìƒˆë¡œìš´ ì¼ì • ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”:");
                if (title) {
                    let newEvent = {
                        title: title,
                        start: arg.startStr,
                        end: arg.endStr
                    };

                    $.ajax({
                        url: "/api/schedules/add",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(newEvent),
                        success: function(data) {
                            calendar.addEvent({
                                id: data.scheduleId,
                                title: data.title + " (ì§ì›: " + data.employeeId + ")",
                                start: data.startDate,
                                end: data.endDate,
                                allDay: true
                            });
                            alert("ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.");
                        },
                        error: function() {
                            alert("ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        }
                    });
                }
                calendar.unselect();
            },

            // âœ… ì¼ì • ìˆ˜ì • (ë“œë˜ê·¸ & ë“œë¡­)
            eventDrop: function(info) {
                let updatedEvent = {
                    scheduleId: info.event.id,
                    title: info.event.title,
                    start: info.event.start ? info.event.start.toISOString() : null,  // âœ… null ë°©ì§€
                    end: info.event.end ? info.event.end.toISOString() : info.event.start.toISOString()
                };

                $.ajax({
                    url: "/api/schedules/update/" + updatedEvent.scheduleId,
                    type: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(updatedEvent),
                    success: function() {
                        alert("ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    },
                    error: function(xhr, status, error) {
                        console.error("ğŸš¨ ìˆ˜ì • ì‹¤íŒ¨:", error);
                        alert("ì¼ì • ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                    }
                });
            },


            // âœ… ì¼ì • ì‚­ì œ (ì¼ì • í´ë¦­ ì‹œ)
            eventClick: function(info) {
                if (confirm("ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                    $.ajax({
                        url: "/api/schedules/delete/" + info.event.id,  // âœ… ì˜¬ë°”ë¥¸ URL ê²½ë¡œ
                        type: "DELETE",
                        success: function() {
                            alert("ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                            info.event.remove(); // UIì—ì„œ ì¦‰ì‹œ ì‚­ì œ
                        },
                        error: function(xhr, status, error) {
                            console.error("ğŸš¨ ì‚­ì œ ì‹¤íŒ¨:", error);
                            alert("ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                        }
                    });
                }
            }
        });

        // ìº˜ë¦°ë” ëœë”ë§
        calendar.render();
    });
    </script>

</body>
</html>
