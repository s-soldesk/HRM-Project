<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>일정 관리</title>
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/ko.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link rel="stylesheet" href="/css/schedule.css">
</head>
<body>
    <div class="container">
        <!-- 사이드바 -->
        <div th:replace="~{layout/sidebar :: sidebar}"></div>

        <!-- 일정 관리 컨텐츠 -->
        <div class="content">
            <h2>일정 관리</h2>
            <p>캘린더를 통해 일정을 추가, 조회, 수정, 삭제할 수 있습니다.</p>

            <!-- FullCalendar -->
            <div id="calendar"></div>
        </div>
    </div>

    <script>
    $(document).ready(function () {
        let calendarTag = $('#calendar')[0]; // full-calendar 생성하기
        let calendar = new FullCalendar.Calendar(calendarTag, {
            height: '550px', // calendar 높이 설정
            expandRows: true, // 화면에 맞게 높이 재설정
            slotMinTime: '00:00', // Day 캘린더에서 시작 시간
            slotMaxTime: '23:59', // Day 캘린더에서 종료 시간

            customButtons: { // 사용자가 만드는 버튼
                testButton: {
                    text: "테스트버튼"
                }
            },
            // 해더에 표시할 툴바
            headerToolbar: { // customButton 은 left 또는 right 안에 넣으면 적용 된다
                left: 'prevYear,prev,next,nextYear today',
                center: 'title',
                right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
            },
            initialView: 'dayGridMonth', // 기본 화면 (월별 보기)
            navLinks: true, // 날짜를 선택하면 Day 캘린더나 Week 캘린더로 링크
            editable: true, // 일정 드래그 이동 가능
            selectable: true, // 날짜 드래그 가능
            nowIndicator: true, // 현재 시간 표시
            dayMaxEvents: true, // 일정 많으면 +로 표시
            locale: 'ko', // 한국어 설정

            // ✅ 일정 조회 (서버에서 일정 가져오기)
            events: function(fetchInfo, successCallback, failureCallback) {
                $.ajax({
                    url: "/api/schedules",
                    type: "GET",
                    dataType: "json",
                    success: function(response) {
                        console.log("📌 일정 데이터:", response);
                        successCallback(response); // 일정 로드
                    },
                    error: function(xhr, status, error) {
                        console.error("🚨 일정 불러오기 실패:", error);
                        failureCallback(error);
                    }
                });
            },

            // ✅ 일정 추가 (일자 클릭 또는 드래그하여 선택)
            select: function(arg) {
                let title = prompt("새로운 일정 제목을 입력하세요:");
                if (title) {
                    let newEvent = {
                        title: title,
                        startDate: arg.startStr,
                        endDate: arg.endStr
                    };

                    $.ajax({
                        url: "/api/schedules",
                        type: "POST",
                        contentType: "application/json",
                        data: JSON.stringify(newEvent),
                        success: function(data) {
                            console.log("✅ 일정 추가 완료:", data);
                            calendar.addEvent({
                                id: data.scheduleId, // 서버에서 반환된 일정 ID 사용
                                title: data.title,
                                start: data.startDate,
                                end: data.endDate,
                                allDay: true
                            });
                            alert("일정이 추가되었습니다.");
                        },
                        error: function() {
                            alert("일정 추가에 실패했습니다.");
                        }
                    });
                }
                calendar.unselect();
            },

            // ✅ 일정 수정 (드래그 & 드롭)
            eventDrop: function(info) {
                let updatedEvent = {
                    scheduleId: info.event.id,
                    title: info.event.title,
                    startDate: info.event.start.toISOString(),
                    endDate: info.event.end ? info.event.end.toISOString() : info.event.start.toISOString()
                };

                $.ajax({
                    url: "/api/schedules/" + updatedEvent.scheduleId,
                    type: "PUT",
                    contentType: "application/json",
                    data: JSON.stringify(updatedEvent),
                    success: function() {
                        alert("일정이 수정되었습니다.");
                    },
                    error: function() {
                        alert("일정 수정에 실패했습니다.");
                    }
                });
            },

            // ✅ 일정 삭제 (일정 클릭 시)
            eventClick: function(info) {
                if (confirm("이 일정을 삭제하시겠습니까?")) {
                    $.ajax({
                        url: "/api/schedules/" + info.event.id,
                        type: "DELETE",
                        success: function() {
                            alert("일정이 삭제되었습니다.");
                            info.event.remove();
                        },
                        error: function() {
                            alert("일정 삭제에 실패했습니다.");
                        }
                    });
                }
            }
        });

        // 캘린더 랜더링
        calendar.render();
    });
    </script>
</body>
</html>
